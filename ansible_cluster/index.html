
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../setup/">
      
      
        <link rel="next" href="../k8s_management/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.16">
    
    
      
        <title>Cluster setup with Ansible - McCl8s</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="pink" data-md-color-accent="purple">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cluster-setup-with-ansible" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="McCl8s" class="md-header__button md-logo" aria-label="McCl8s" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            McCl8s
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Cluster setup with Ansible
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="pink" data-md-color-accent="purple"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="pink" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="McCl8s" class="md-nav__button md-logo" aria-label="McCl8s" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    McCl8s
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../topics/" class="md-nav__link">
        Learning topics
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../setup/" class="md-nav__link">
        Setup
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Cluster setup with Ansible
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Cluster setup with Ansible
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    Getting started
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-the-inventory" class="md-nav__link">
    Creating the inventory
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-roles" class="md-nav__link">
    Creating roles
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-playbooks" class="md-nav__link">
    Setting up playbooks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-playbooks" class="md-nav__link">
    Running playbooks
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../k8s_management/" class="md-nav__link">
        Managing a MicroK8s cluster
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../first_deployments/" class="md-nav__link">
        First deployments
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../kubeflow/" class="md-nav__link">
        Kubeflow
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../vanilla/" class="md-nav__link">
        Vanilla Kubernetes
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    Getting started
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-the-inventory" class="md-nav__link">
    Creating the inventory
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-roles" class="md-nav__link">
    Creating roles
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-playbooks" class="md-nav__link">
    Setting up playbooks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-playbooks" class="md-nav__link">
    Running playbooks
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="cluster-setup-with-ansible">Cluster setup with Ansible</h1>
<p>For this setup, four Raspberry Pi nodes are available on the network. We
will configure one as both a network DNS server and as a test node for
applying
<a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_intro.html">Ansible playbooks</a>.
We will configure the remaining three nodes to join our MicroK8s cluster
as workers nodes.</p>
<h2 id="getting-started">Getting started</h2>
<p><a href="https://docs.ansible.com/ansible/latest/getting_started/index.html">Ansible documentation</a>
introduces three main components of an Ansible environment:</p>
<ol>
<li>A <strong>control node</strong>, where Ansible is installed.</li>
<li><strong>Managed nodes</strong>, remote hosts that Ansible controls.</li>
<li><strong>Inventory</strong>, a list of logically organized managed nodes.</li>
</ol>
<p>In this parlance, the WSL 2 machine will behave as the control node, and the
four Raspberry Pi machines as managed nodes.</p>
<h2 id="creating-the-inventory">Creating the inventory</h2>
<p>Ansible inventories defines the managed nodes to automate, with groups so you
can run automation tasks on multiple hosts at the same time. With an inventory
defined, you can use patterns to select the hosts or groups for Ansible to run
against.</p>
<p>For example, with a cluster of 4 Raspberry Pi systems with a default user <code>pi</code>,
an inventory might look like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">[raspberrypis]</span>
<span class="na">192.168.1.100</span>
<span class="na">192.168.1.101</span>
<span class="na">192.168.1.102</span>
<span class="na">192.168.1.103</span>

<span class="k">[raspberrypis:vars]</span>
<span class="na">ansible_user</span><span class="o">=</span><span class="s">pi</span>
</code></pre></div>
<blockquote>
<p>The <code>ansible_user</code> ensures connections are established using the <code>pi</code> user
if the user on the control node is another username.</p>
</blockquote>
<p>The default location for the inventory file is <code>/etc/ansible/hosts</code>.
One can use another location and specify that file when running ansible
commands (here, with <code>-i ~/.ansible/etc/hosts</code>):</p>
<div class="highlight"><pre><span></span><code>ansible<span class="w"> </span>-i<span class="w"> </span>~/.ansible/etc/hosts<span class="w"> </span>raspberrypis<span class="w"> </span>-m<span class="w"> </span>ping
<span class="m">192</span>.168.1.102<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">SUCCESS</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;ansible_facts&quot;</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="s2">&quot;discovered_interpreter_python&quot;</span>:<span class="w"> </span><span class="s2">&quot;/usr/bin/python3&quot;</span>
<span class="w">    </span><span class="o">}</span>,
<span class="w">    </span><span class="s2">&quot;changed&quot;</span>:<span class="w"> </span>false,
<span class="w">    </span><span class="s2">&quot;ping&quot;</span>:<span class="w"> </span><span class="s2">&quot;pong&quot;</span>
<span class="o">}</span>
<span class="m">192</span>.168.1.101<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">SUCCESS</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;ansible_facts&quot;</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="s2">&quot;discovered_interpreter_python&quot;</span>:<span class="w"> </span><span class="s2">&quot;/usr/bin/python3&quot;</span>
<span class="w">    </span><span class="o">}</span>,
<span class="w">    </span><span class="s2">&quot;changed&quot;</span>:<span class="w"> </span>false,
<span class="w">    </span><span class="s2">&quot;ping&quot;</span>:<span class="w"> </span><span class="s2">&quot;pong&quot;</span>
<span class="o">}</span>
<span class="m">192</span>.168.1.100<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">SUCCESS</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;ansible_facts&quot;</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="s2">&quot;discovered_interpreter_python&quot;</span>:<span class="w"> </span><span class="s2">&quot;/usr/bin/python3&quot;</span>
<span class="w">    </span><span class="o">}</span>,
<span class="w">    </span><span class="s2">&quot;changed&quot;</span>:<span class="w"> </span>false,
<span class="w">    </span><span class="s2">&quot;ping&quot;</span>:<span class="w"> </span><span class="s2">&quot;pong&quot;</span>
<span class="o">}</span>
<span class="m">192</span>.168.1.103<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">SUCCESS</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;ansible_facts&quot;</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="s2">&quot;discovered_interpreter_python&quot;</span>:<span class="w"> </span><span class="s2">&quot;/usr/bin/python3&quot;</span>
<span class="w">    </span><span class="o">}</span>,
<span class="w">    </span><span class="s2">&quot;changed&quot;</span>:<span class="w"> </span>false,
<span class="w">    </span><span class="s2">&quot;ping&quot;</span>:<span class="w"> </span><span class="s2">&quot;pong&quot;</span>
<span class="o">}</span>
</code></pre></div>
<p>A richer format for an inventory file is YAML. Here, we modify the previous
example to provide named hosts for each IP:</p>
<div class="highlight"><pre><span></span><code><span class="nt">raspberrypis</span><span class="p">:</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">raspberrypi-0</span><span class="p">:</span>
<span class="w">      </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.100</span>
<span class="w">    </span><span class="nt">raspberrypi-1</span><span class="p">:</span>
<span class="w">      </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.101</span>
<span class="w">    </span><span class="nt">raspberrypi-2</span><span class="p">:</span>
<span class="w">      </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.102</span>
<span class="w">    </span><span class="nt">raspberrypi-3</span><span class="p">:</span>
<span class="w">      </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.103</span>
<span class="w">  </span><span class="nt">vars</span><span class="p">:</span>
<span class="w">    </span><span class="nt">ansible_user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pi</span>
</code></pre></div>
<p>The inventory we'll use throughout this documentation looks like:</p>
<div class="highlight"><pre><span></span><code><span class="nt">pis</span><span class="p">:</span>
<span class="w">  </span><span class="nt">children</span><span class="p">:</span>
<span class="w">    </span><span class="nt">canary</span><span class="p">:</span>
<span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">        </span><span class="nt">raspberrypi-0</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.100</span>
<span class="w">    </span><span class="nt">raspi3s</span><span class="p">:</span>
<span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">        </span><span class="nt">raspberrypi-0</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.100</span>
<span class="w">        </span><span class="nt">raspberrypi-1</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.101</span>
<span class="w">        </span><span class="nt">raspberrypi-2</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.102</span>
<span class="w">        </span><span class="nt">raspberrypi-3</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.103</span>
<span class="w">    </span><span class="nt">raspi4s</span><span class="p">:</span>
<span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">        </span><span class="nt">vatomouro-0</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.110</span>
<span class="w">        </span><span class="nt">vatomouro-1</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.111</span>
<span class="w">        </span><span class="nt">vatomouro-2</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.112</span>
<span class="w">        </span><span class="nt">vatomouro-3</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.113</span>
<span class="w">    </span><span class="nt">raspis</span><span class="p">:</span>
<span class="w">      </span><span class="nt">children</span><span class="p">:</span>
<span class="w">        </span><span class="nt">raspi3s</span><span class="p">:</span>
<span class="w">        </span><span class="nt">raspi4s</span><span class="p">:</span>
<span class="w">    </span><span class="nt">rockpis</span><span class="p">:</span>
<span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">        </span><span class="nt">vrachos-0</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.120</span>
<span class="w">        </span><span class="nt">vrachos-1</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.121</span>
<span class="w">        </span><span class="nt">vrachos-2</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.122</span>
<span class="w">        </span><span class="nt">vrachos-3</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.123</span>
<span class="w">        </span><span class="nt">vrachos-4</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.124</span>
<span class="w">        </span><span class="nt">vrachos-5</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.125</span>
<span class="w">      </span><span class="nt">vars</span><span class="p">:</span>
<span class="w">        </span><span class="nt">ansible_user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rock</span>
<span class="w">    </span><span class="nt">k8scontrol</span><span class="p">:</span>
<span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">        </span><span class="nt">vatomouro-0</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.110</span>
<span class="w">        </span><span class="nt">vatomouro-1</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.111</span>
<span class="w">        </span><span class="nt">vatomouro-2</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.112</span>
<span class="w">    </span><span class="nt">k8sworkers</span><span class="p">:</span>
<span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">        </span><span class="nt">vatomouro-3</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.113</span>
<span class="w">        </span><span class="nt">vrachos-0</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.120</span>
<span class="w">        </span><span class="nt">vrachos-1</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.121</span>
<span class="w">        </span><span class="nt">vrachos-2</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.122</span>
<span class="w">    </span><span class="nt">k8sstorage</span><span class="p">:</span>
<span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">        </span><span class="nt">vrachos-3</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.123</span>
<span class="w">        </span><span class="nt">vrachos-4</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.124</span>
<span class="w">        </span><span class="nt">vrachos-5</span><span class="p">:</span>
<span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.125</span>
<span class="w">    </span><span class="nt">k8s</span><span class="p">:</span>
<span class="w">      </span><span class="nt">children</span><span class="p">:</span>
<span class="w">        </span><span class="nt">k8scontrol</span><span class="p">:</span>
<span class="w">        </span><span class="nt">k8sworkers</span><span class="p">:</span>
<span class="w">        </span><span class="nt">k8sstorage</span><span class="p">:</span>
<span class="w">  </span><span class="nt">vars</span><span class="p">:</span>
<span class="w">    </span><span class="nt">ansible_user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pi</span>
<span class="w">    </span><span class="nt">control_plane_endpoint</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.clunacy.dev</span>
<span class="w">    </span><span class="nt">apiserver_vip</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.150</span>
<span class="w">    </span><span class="nt">pod_network_cidr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.90.0.0/16</span>
<span class="w">    </span><span class="nt">ip_address_pool_addresses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.1.192/27</span>
</code></pre></div>
<p>This inventory defines a <code>raspberrypis</code> group that contains to child groups:
a <code>canary</code> test group, and a <code>k8s</code> group. All hosts are accessed as user <code>pi</code>,
so we define <code>ansible_user</code> accordingly.</p>
<h2 id="creating-roles">Creating roles</h2>
<p>Echoing the
<a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse_roles.html">Roles documentation</a>
for Ansible:</p>
<blockquote>
<p>Roles let you automatically load related vars, files, tasks, handlers, and
other Ansible artifacts based on a known file structure. After you group your
content in roles, you can easily reuse them and share them with other users.</p>
</blockquote>
<p>There are three roles needed to configure the Pis:</p>
<ol>
<li>A <code>common</code> role, for tasks shared by all nodes. Every node, for example,
   should be updated and upgraded. And every node should have <code>snap</code> and
   <code>microk8s</code> installed.</li>
<li>A <code>dnsservers</code> role, unique to the test node that we will use as our
   local network DNS server.</li>
<li>A <code>workers</code> role, unique to the <code>k8s</code> group, the nodes that will join
   the <code>microk8s</code> cluster as workers.</li>
</ol>
<blockquote>
<p>NOTE: The WSL 2 machine is behaving as both the MicroK8s cluster control
plane and the Ansible control node.</p>
</blockquote>
<p>The details of the <code>common</code> and <code>dnsservers</code> roles are not covered here, but
the implementations for each can be viewed in the
<a href="https://github.com/McClunatic/k8s-learning/tree/main/ansible/roles">source code</a>.
The <code>tasks/main.yml</code> for the <code>workers</code> is shown below:</p>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">--8&lt;-- ansible/roles/workers/tasks/main.yml</span>
</code></pre></div>
<p>Worth highlighting here are the presence of <em>variables</em> that Ansible can
populate either from variables files or the command line at runtime. We will
make use of the <code>microk8s_instance</code> variable when running an associated
<a href="#setting-up-playbooks">playbook</a>.</p>
<h2 id="setting-up-playbooks">Setting up playbooks</h2>
<p>With our three <a href="#creating-roles">roles</a> defined, there are three associated
playbooks to create:</p>
<ol>
<li><code>site.yml</code> to update all nodes and install <code>microk8s</code>,</li>
<li><code>dns.yml</code> to create a DNS server (and to update all other nodes to use
   that server), and</li>
<li><code>k8sworkers.yml</code> to join <code>k8s</code> nodes to the MicroK8s cluster.</li>
</ol>
<p>In each, we can refer to associated roles to run their tasks. For example,
the <code>k8sworkers.yml</code> playbook looks like this:</p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<p>The remaining two playbooks
<a href="https://github.com/McClunatic/k8s-learning/tree/main/ansible/roles">source code</a>.
In our <code>k8sworkers.yml</code> playbook, we can see by default that <code>k8s</code> hosts are
targeted from our inventory, but that <code>variable_host</code> can be used to
override that setting at runtime. This is useful for testing configuration
changes on our <code>canary</code> host before rolling out to <code>k8s</code> hosts.</p>
<h2 id="running-playbooks">Running playbooks</h2>
<p>Playbooks are run using the <code>ansible-playbook</code> CLI:</p>
<div class="highlight"><pre><span></span><code>ansible-playbook<span class="w"> </span>-h
</code></pre></div>
<p>For our playbooks, we'll run them with one other argument to indicate the
inventory file to use. For example, running the <code>site.yml</code> playbook
from our <code>ansible/</code> repository directory looks like this:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>ansible/
ansible-playbook<span class="w"> </span>-i<span class="w"> </span>inventory.yml<span class="w"> </span>site.yml
</code></pre></div>
<p>The more interesting playbook is our <code>k8sworkers.yml</code> playbook. To
<a href="https://microk8s.io/docs/clustering">add nodes to MicroK8s</a>, the
follow command must first be run from cluster master node:</p>
<div class="highlight"><pre><span></span><code>microk8s<span class="w"> </span>add-node
</code></pre></div>
<p>It outputs instructions like the following, which include URLs with unique
tokens and associated expiry times:</p>
<div class="highlight"><pre><span></span><code>From<span class="w"> </span>the<span class="w"> </span>node<span class="w"> </span>you<span class="w"> </span>wish<span class="w"> </span>to<span class="w"> </span>join<span class="w"> </span>to<span class="w"> </span>this<span class="w"> </span>cluster,<span class="w"> </span>run<span class="w"> </span>the<span class="w"> </span>following:
microk8s<span class="w"> </span>join<span class="w"> </span><span class="m">192</span>.168.1.230:25000/92b2db237428470dc4fcfc4ebbd9dc81/2c0cb3284b05

Use<span class="w"> </span>the<span class="w"> </span><span class="s1">&#39;--worker&#39;</span><span class="w"> </span>flag<span class="w"> </span>to<span class="w"> </span>join<span class="w"> </span>a<span class="w"> </span>node<span class="w"> </span>as<span class="w"> </span>a<span class="w"> </span>worker<span class="w"> </span>not<span class="w"> </span>running<span class="w"> </span>the<span class="w"> </span>control<span class="w"> </span>plane,<span class="w"> </span>eg:
microk8s<span class="w"> </span>join<span class="w"> </span><span class="m">192</span>.168.1.230:25000/92b2db237428470dc4fcfc4ebbd9dc81/2c0cb3284b05<span class="w"> </span>--worker

If<span class="w"> </span>the<span class="w"> </span>node<span class="w"> </span>you<span class="w"> </span>are<span class="w"> </span>adding<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>reachable<span class="w"> </span>through<span class="w"> </span>the<span class="w"> </span>default<span class="w"> </span>interface<span class="w"> </span>you<span class="w"> </span>can<span class="w"> </span>use<span class="w"> </span>one<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>following:
microk8s<span class="w"> </span>join<span class="w"> </span><span class="m">192</span>.168.1.230:25000/92b2db237428470dc4fcfc4ebbd9dc81/2c0cb3284b05
microk8s<span class="w"> </span>join<span class="w"> </span><span class="m">10</span>.23.209.1:25000/92b2db237428470dc4fcfc4ebbd9dc81/2c0cb3284b05
microk8s<span class="w"> </span>join<span class="w"> </span><span class="m">172</span>.17.0.1:25000/92b2db237428470dc4fcfc4ebbd9dc81/2c0cb3284b05
</code></pre></div>
<p>To run our playbook, we first need to obtain a join URL from the MicroK8s
cluster master, and then provide that URL to the task in <code>workers</code> role,
awaiting it via the variable <code>microk8s_instance</code>
(see <a href="#creating-roles">Creating roles</a>).</p>
<p>Running that playbook might look like this:</p>
<div class="highlight"><pre><span></span><code>ansible-playbook<span class="w"> </span>-i<span class="w"> </span>inventory.yml<span class="w"> </span>k8sworkers.yml<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--extra-vars<span class="w"> </span><span class="s2">&quot;microk8s_instance=192.168.1.230:25000/92b2db237428470dc4fcfc4ebbd9dc81/2c0cb3284b05&quot;</span>
</code></pre></div>
<p>Here's a handy one-liner to both extend the token expiry time and capture the
URL:</p>
<div class="highlight"><pre><span></span><code>ansible-playbook<span class="w"> </span>-i<span class="w"> </span>inventory.yml<span class="w"> </span>k8sworkers.yml<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--extra-vars<span class="w"> </span><span class="s2">&quot;microk8s_instance=</span><span class="k">$(</span>microk8s<span class="w"> </span>add-node<span class="w"> </span>--token-ttl<span class="w"> </span><span class="m">3600</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>microk8s<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-1<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">&#39; &#39;</span><span class="w"> </span>-f3<span class="k">)</span><span class="s2">&quot;</span>
</code></pre></div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.a51614de.min.js"></script>
      
    
  </body>
</html>